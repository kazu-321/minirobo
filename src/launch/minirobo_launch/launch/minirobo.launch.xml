<?xml version="1.0"?>
<launch>
    <arg name="urdf_path" default="$(find-pkg-share minirobo_launch)/urdf/minirobo.urdf.xacro"/>
    <arg name="joint_state_topics" default="['/swerve/command_joint_states', '/controller/joint_states']"/>

    <node_container pkg="rclcpp_components" exec="component_container" name="joint_state_container" namespace="/">
        <composable_node pkg="robot_state_publisher" plugin="robot_state_publisher::RobotStatePublisher" name="robot_state_publisher" namespace="/">
            <param name="robot_description" value="$(command 'xacro $(var urdf_path)')"/>
            <param name="frame_prefix" value=""/>
            <param name="publish_frequency" value="100.0"/>
        </composable_node>

        <composable_node pkg="robot_state_publisher" plugin="robot_state_publisher::RobotStatePublisher" name="command_robot_state_publisher" namespace="/">
            <param name="robot_description" value="$(command 'xacro $(var urdf_path)')"/>
            <remap from="/joint_states" to="/command_joint_states"/>
            <param name="frame_prefix" value="command/"/>
            <remap from="/robot_description" to="/command_robot_description"/>
            <param name="publish_frequency" value="100.0"/>
        </composable_node>

        <composable_node pkg="natto_joint_state" plugin="joint_state_merger::joint_state_merger" name="joint_state_merger" namespace="/">
            <param name="joint_state_topics" value="$(var joint_state_topics)"/>
            <remap from="/merged_joint_states" to="/command_joint_states"/>
        </composable_node>

        <composable_node pkg="tf2_ros" plugin="tf2_ros::StaticTransformBroadcasterNode" name="base_to_command_base" namespace="/">
            <param name="frame_id" value="base_link"/>
            <param name="child_frame_id" value="command/base_link"/>
        </composable_node>
    </node_container>

    <node_container pkg="rclcpp_components" exec="component_container" name="calculator_container" namespace="localization">
        <composable_node pkg="natto_chassis_calculator" plugin="chassis_calculator::chassis_calculator" name="chassis_calculator" namespace="/control/swerve">
            <param from="$(find-pkg-share minirobo_launch)/param/robot.yaml"/>
            <remap from="command_joint_states" to="/swerve/command_joint_states"/>
            <remap from="joint_states" to="/joint_states"/>
            <remap from="command_velocity" to="/command_velocity"/>
        </composable_node>

        <composable_node pkg="natto_wheel_odometry" plugin="wheel_odometry::wheel_odometry" name="wheel_odometry" namespace="localization/wheel_odometry">
            <param from="$(find-pkg-share minirobo_launch)/param/robot.yaml"/>
            <param name="publish_tf" value="true"/>
            <remap from="joint_states" to="/joint_states"/>
        </composable_node>
    </node_container>

    <node_container pkg="rclcpp_components" exec="component_container" name="controller_container" namespace="/controller">
        <composable_node pkg="joy" plugin="joy::Joy" name="joy_node" namespace="/controller">
            <param name="deadzone" value="0.1"/>
            <param name="autorepeat_rate" value="100.0"/>
        </composable_node>
        <composable_node pkg="natto_joy" plugin="joy_to_twist::joy_to_twist" name="joy_to_twist" namespace="/controller">
            <param name="max_xy_speed_m_s" value="0.5"/>
            <param name="max_yaw_speed_rad_s" value="3.0"/>
            <remap from="command_velocity" to="/command_velocity"/>
            <remap from="joy" to="/controller/joy"/>
        </composable_node>
        <composable_node pkg="natto_joy" plugin="button_manager::button_manager" name="button_manager" namespace="/controller">
            <param from="$(find-pkg-share minirobo_launch)/param/controller.yaml"/>
        </composable_node>
    </node_container>


    <node pkg="rviz2" exec="rviz2" name="rviz2" output="screen"
        args="-d $(find-pkg-share minirobo_launch)/rviz/dark_rviz.rviz --stylesheet $(find-pkg-share natto_launch)/rviz/dark.qss"/>

    <node_container pkg="rclcpp_components" exec="component_container" name="communication_container" namespace="/can">
        <composable_node pkg="natto_canable" plugin="canable::canable" name="canable">
            <param name="use_fd" value="true"/>
            <remap from="transmit" to="/can/transmit"/>
            <remap from="receive" to="/can/receive"/>
        </composable_node>
        <composable_node pkg="natto_can_bridge" plugin="can_bridge::can_bridge" name="can_bridge">
            <param from="$(find-pkg-share minirobo_launch)/param/can.yaml"/>
            <remap from="transmit" to="/can/transmit"/>
            <remap from="receive" to="/can/receive"/>
            <remap from="power" to="/controller/power"/>
        </composable_node>
    </node_container>
    
</launch>
